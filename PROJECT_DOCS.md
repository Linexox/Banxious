# GreenBanana (撕碎蕉绿) 项目文档

## 1. 项目概述
GreenBanana 是一个结合了AI心理咨询与互动式解压体验的应用程序。项目通过"心情实验室"的概念，让用户在与AI的对话中探索内心，最终生成一张象征焦虑的"卡片"，并通过撕碎、烧毁等仪式化的互动来释放情绪。

---

## 2. 项目结构

项目采用前后端分离架构，前端为微信小程序，后端为 Python (FastAPI)。

### 2.1 后端 (backend/)
基于 FastAPI 框架，负责 AI 对话流、卡片生成逻辑和数据存储。

*   **`app/main.py`**: 应用入口，配置中间件和路由。
*   **`app/api/views.py`**: 定义 API 接口 (`/chat`, `/generate_card`, `/log`)，处理 HTTP 请求并调用服务层。
*   **`app/services/`**: 业务逻辑层。
    *   `chat_service.py`: 封装对话核心逻辑，包括流式响应、知识库检索、消息构建和历史记录管理。
    *   `card_service.py`: 封装卡片生成逻辑，处理后台任务、LLM 调用和缓存。
*   **`app/storage/conversation_storage.py`**: 数据持久化层，管理用户对话历史和卡片缓存（目前使用内存/文件存储）。
*   **`app/templates/prompt_templates.py`**: 集中管理 LLM 的 System Prompts（包括简洁模式、专业模式的设定）。
*   **`app/api/utils/`**: 工具模块。
    *   `factory.py`: LLM 客户端工厂模式实现（支持 ZhipuAI, DeepSeek 等）。
    *   `psychology_knowledge.py`: 简单的心理学知识库检索工具。
*   **`config/settings.py`**: 项目配置（API Key, 模型选择等）。

### 2.2 前端 (miniprogram/)
基于微信小程序原生框架，提供沉浸式交互体验。

*   **`pages/`**: 页面逻辑。
    *   `index/`: 首页（Mood Lab），引导用户进入。
    *   `chat/`: 对话页面，实现打字机效果、流式接收、引导式回复选择。
    *   `result/`: 结果页，展示生成的焦虑卡片，并包含 Canvas 销毁动画（烧毁、撕碎、揉皱）。
*   **`components/`**: 可复用组件。
    *   `card-machine/`: 拟物化卡片生成机动画组件。
    *   `chat-input/`: 聊天输入框组件。
    *   `chat-message/`: 聊天气泡组件。
*   **`utils/`**: 通用工具。
    *   `api.js`: 封装 `wx.request`，处理 API 调用和 Promise。

---

## 3. 重点技术细节

### 3.1 界面与交互设计
*   **拟物化设计 (Skeuomorphism)**: 核心界面采用复古实验室风格，通过 "Card Maker" 机器的运作动画连接对话与结果环节，增强沉浸感。
*   **日夜模式切换**: 
    *   **Day Mode (输入阶段)**: 暖色调，营造安全、接纳的对话氛围。
    *   **Night Mode (释放阶段)**: 冷色调/深色背景，配合卡片销毁的视觉冲击，强化释放感。

### 3.2 AI 对话系统
*   **流式响应 (Streaming)**: 使用 Server-Sent Events (SSE) 机制（通过 FastAPI `StreamingResponse`），实现打字机效果，降低用户等待焦虑。
*   **引导式对话**:
    *   **轮次控制**: 在 Prompt 中严格限制对话为 8-10 轮，确保在有限交互内完成"建立信任-探索-建议"的闭环。
    *   **智能预设 (Suggestions)**: AI 在每次回复末尾生成 JSON 格式的建议选项 (`|||SUGGESTIONS=[...]|||`)，前端解析后渲染为可点击的 Chip，降低用户认知负担。
    *   **心理咨询原则**: System Prompt 内置心理咨询框架（共情、倾听、苏格拉底式提问），区分"简洁模式"（直接建议）和"专业模式"（深度挖掘）。

### 3.3 焦虑卡片生成
*   **异步生成**: 对话结束后，后端触发后台任务 (`BackgroundTasks`) 生成卡片内容，避免阻塞 API 响应。
*   **缓存机制**: 生成结果缓存于 `backend/data/card_cache/`，再次请求时优先读取缓存，提高响应速度。
*   **内容结构**: 卡片包含 "焦虑关键词"、"核心信念"、"应对建议" 等结构化信息，由 LLM 基于对话历史总结生成。

### 3.4 销毁动画逻辑 (Canvas 2D)
*   **渲染策略**: 使用小程序 Canvas 2D 接口。在动画开始前，将 DOM 节点的卡片内容绘制到 Canvas 上，实现无缝切换。
*   **物理效果**:
    *   **烧毁 (Burn)**: 基于粒子系统，模拟火焰边缘的扩散和黑洞效果，粒子向上飘动并透明度渐变。
    *   **撕碎 (Tear)**: 计算触摸轨迹，利用多边形切割算法将卡片图像分割为两个独立的多边形网格，并赋予重力下落效果。
    *   **揉皱 (Crush)**: 动态扭曲网格顶点，模拟纸张受力变形的视觉效果，配合缩小和位移。

---

## 4. 用户体验 (UX) 设计细节

*   **情感化引导**: 这里的 AI 不仅仅是问答机器，而是被设定为"心理咨询师"。它会主动确认用户情绪，并在给出建议前进行认知探索。
*   **仪式感**:
    *   **生成仪式**: 卡片不是直接弹出，而是伴随着机器的轰鸣、齿轮转动、灯光闪烁，最终"打印"出来。
    *   **销毁仪式**: 用户必须通过物理手势（长按、滑动、多点触控）来销毁卡片，这种身体参与感强化了心理上的"放下"暗示。
*   **容错与反馈**: 
    *   前端实现了强大的 JSON 解析容错机制（三级降级策略），确保即时 AI 输出格式有误，也能尽可能正确渲染建议选项。
    *   流式输出中的网络波动、格式错误都会被静默处理或优雅降级，不打断用户心流。
