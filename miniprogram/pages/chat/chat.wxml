<view class="container">
  
  <!-- 1. Healing Progress Bar -->
  <view class="progress-container">
    <image class="progress-icon left" src="../../images/banana_green.png" mode="aspectFit" wx:if="{{false}}"></image> <!-- Placeholder check -->
    <view class="progress-icon-placeholder left" style="background-color: {{progress < 100 ? '#4CAF50' : '#FFEB3B'}}"></view>
    
    <view class="progress-track">
      <view class="progress-fill" style="width: {{progress}}%;"></view>
    </view>
    
    <view class="progress-icon-placeholder right" style="background-color: #FFEB3B"></view>
  </view>

  <!-- Prompt Mode Switch -->
  <view class="mode-switch-container" bindtap="onToggleMode">
    <view class="mode-bg">
        <view class="mode-slider {{mode === 'professional' ? 'right' : 'left'}}"></view>
    </view>
    <view class="mode-labels">
        <text class="mode-text {{mode === 'chat' ? 'active' : ''}}">ÂπΩÈªò</text>
        <text class="mode-text {{mode === 'professional' ? 'active' : ''}}">‰∏ì‰∏ö</text>
    </view>
  </view>

  <!-- Card Entry (Visible when progress >= 70%) -->
  <view class="card-entry-wrapper {{showCardEntry ? 'show' : ''}}" bindtap="onGenerateCard">
    
    <!-- Asset Mode (Only if assets exist AND placeholder mode is off) -->
    <block wx:if="{{!assets.config.usePlaceholders && (assets.sequences.cardProduction || assets.cardEntry.image.src)}}">
        <view class="card-entry-content">
            <sequence-animator 
                width="40" 
                height="40" 
                sequenceConfig="{{assets.sequences.cardProduction}}" 
                autoPlay="{{true}}"
                wx:if="{{assets.sequences.cardProduction}}"
            ></sequence-animator>
            
            <block wx:elif="{{assets.cardEntry.image.src}}">
                <image 
                    src="{{assets.cardEntry.image.src}}" 
                    class="card-entry-image" 
                    mode="aspectFit"
                ></image>
                <text>ÁîüÊàêÂç°Áâá</text>
            </block>
        </view>
    </block>

    <!-- Placeholder Mode (Fallback) -->
    <block wx:else>
        <view class="card-entry-content">
            <view class="card-icon" style="background-color: {{assets.cardEntry.placeholder.color}};">
                <view class="card-body"></view>
            </view>
            <text>{{assets.cardEntry.placeholder.text}}</text>
        </view>
    </block>

    <view class="card-entry-close" catchtap="onCloseCardEntry">√ó</view>
    <view class="card-entry-shine"></view>
  </view>

  <!-- 2. Main Chat Area -->
  <scroll-view 
    class="chat-list" 
    scroll-y 
    scroll-into-view="{{toView}}"
    scroll-with-animation
    enable-flex="true"
  >
    <view class="chat-content">
      <block wx:for="{{messages}}" wx:key="index">
        <view class="chat-message-item" wx:if="{{item.content || item.role === 'user'}}">
          <chat-message msg="{{item}}"></chat-message>
        </view>
      </block>

      <view class="ai-typing-container" wx:if="{{loading && messages[messages.length-1].role === 'assistant' && !messages[messages.length-1].content}}">
         <view class="typing-bubble left">
            <view class="dot"></view><view class="dot"></view><view class="dot"></view>
         </view>
      </view>
      
      <!-- 3. Suggestions Layer (Moved into flow) -->
      <view class="suggestions-layer" wx:if="{{suggestions.length > 0 && !loading}}">
        <view 
          class="suggestion-bubble" 
          wx:for="{{suggestions}}" 
          wx:key="index" 
          bindtap="onSuggestionTap" 
          data-text="{{item}}"
        >
          <text>{{item}}</text>
        </view>
      </view>
      
      <view id="bottom" style="height: 1px; width: 100%"></view>
    </view>
  </scroll-view>

  <!-- 4. Cats Layer -->
   <view class="user-typing-layer" wx:if="{{isUserTyping}}">
      <view class="typing-bubble right">
        <view class="dot"></view><view class="dot"></view><view class="dot"></view>
      </view>
   </view>

  <!-- 4. Cats Layer -->
  <view class="cats-layer">
    <view class="ai-cat-container">
      <view class="cat-avatar ai {{isTalking ? 'talking' : ''}}">
        <image 
            wx:if="{{assets.avatars.cat.src}}" 
            src="{{assets.avatars.cat.src}}" 
            mode="aspectFit" 
            class="avatar-image"
        ></image>
        <text wx:else>üê±</text>
      </view>
    </view>

    <view class="user-cat-container">
      <view class="cat-avatar user {{isUserTyping ? 'typing' : ''}}">
        <image 
            wx:if="{{userCatUrl}}" 
            src="{{userCatUrl}}" 
            mode="aspectFit" 
            class="avatar-image"
        ></image>
        <text wx:else>üò∫</text>
      </view>
    </view>
  </view>

  <!-- 5. Input Area -->
  <view class="input-area">
    <chat-input bind:send="onSend" bind:typing="onUserTyping" disabled="{{loading}}"></chat-input>
  </view>

</view>
